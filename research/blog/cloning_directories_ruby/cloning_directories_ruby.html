<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Untitled</title>
    <meta name="author" content="Andy Bulka">

    <!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->

</head>

<body>
    <!-- <script src="js/scripts.js"></script> -->

    <p><span style="line-height: 28px; font-size: 21px;">Cloning Directories in Ruby using Hard Links</span></p>
<p>Hard links exist under windows 7 so you can clone huge directories or files without taking up any extra disk space.  Both the original and the copy are equal and apps can't tell the difference between them - because we are using true hard links (not shortcuts or symbolic links).</p>
<p>The dos command for cloning a file is simply</p>
<p><strong>mklink /H original clone</strong></p>
<p>If you delete the original file, the clone is still there and indistinguishable from the original file.  You can clone as many times as you like and no extra disk space is used.</p>
<p>I'm not aware of a way of recursively hard linking directories (files as hard links, sub directories as real directories) in windows <span style="text-decoration: line-through;">or linux</span> using the standard commands, so here is a recursive directory cloning utility written in Ruby.  It uses the FileUtils.ln method to do the file cloning.  This works under both windows 7 and linux.</p>
<div class="ruby" style="font-family: monospace; color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;"><span style="color: #008000; font-style: italic;"># ln_r</span><br /> <span style="color: #008000; font-style: italic;"># Copy a directory recursively creating hardlinks for files and real dirs for directories</span><br /> <span style="color: #008000; font-style: italic;"># Andy Bulka, Reilly Beacom</span><br /> <span style="color: #008000; font-style: italic;"># version 1.5</span><br /> <br /> <span style="color: #cc0066; font-weight: bold;">require</span> <span style="color: #996600;">'fileutils'</span><br /> <span style="color: #cc0066; font-weight: bold;">require</span> <span style="color: #996600;">'optparse'</span><br /> <br /> <span style="color: #9966cc; font-weight: bold;">def</span> ln_r source, target, options = <span style="color: #006600; font-weight: bold;">{</span>:verbose <span style="color: #006600; font-weight: bold;">=&gt;</span> <span style="color: #0000ff; font-weight: bold;">true</span>, <span style="color: #ff3333; font-weight: bold;">:report</span> <span style="color: #006600; font-weight: bold;">=&gt;</span> <span style="color: #0000ff; font-weight: bold;">true</span>, <span style="color: #ff3333; font-weight: bold;">:countsize</span> <span style="color: #006600; font-weight: bold;">=&gt;</span> <span style="color: #0000ff; font-weight: bold;">false</span>, options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:deletetarget</span><span style="color: #006600; font-weight: bold;">]</span> <span style="color: #006600; font-weight: bold;">=&gt;</span> <span style="color: #0000ff; font-weight: bold;">true</span><span style="color: #006600; font-weight: bold;">}</span><br /> <br />   verbose = options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:verbose</span><span style="color: #006600; font-weight: bold;">]</span><br />   <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"ln_r copying and hard linking from #{source} to #{target}"</span> <span style="color: #9966cc; font-weight: bold;">if</span> verbose<br />   <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"..."</span> <span style="color: #9966cc; font-weight: bold;">if</span> verbose<br /> <br />   <span style="color: #cc0066; font-weight: bold;">raise</span> <span style="color: #996600;">"source not a directory"</span> <span style="color: #9966cc; font-weight: bold;">if</span> <span style="color: #9966cc; font-weight: bold;">not</span> <span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">directory</span>?<span style="color: #006600; font-weight: bold;">(</span>source<span style="color: #006600; font-weight: bold;">)</span><br /> <br />   <span style="color: #008000; font-style: italic;"># Add trailing slash</span><br />   source = <span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">join</span><span style="color: #006600; font-weight: bold;">(</span>source, <span style="color: #996600;">""</span><span style="color: #006600; font-weight: bold;">)</span><br />   target = <span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">join</span><span style="color: #006600; font-weight: bold;">(</span>target, <span style="color: #996600;">""</span><span style="color: #006600; font-weight: bold;">)</span><br /> <br />   <span style="color: #008000; font-style: italic;"># Ensure target dir exists before we start and delete destination files</span><br />   <span style="color: #cc00ff; font-weight: bold;">FileUtils</span>.<span style="color: #9900cc;">mkdir_p</span> target<br />   <span style="color: #cc00ff; font-weight: bold;">FileUtils</span>.<span style="color: #9900cc;">rm_r</span> <span style="color: #cc00ff; font-weight: bold;">Dir</span>.<span style="color: #9900cc;">glob</span><span style="color: #006600; font-weight: bold;">(</span><span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">join</span><span style="color: #006600; font-weight: bold;">(</span>target, <span style="color: #996600;">'/*'</span><span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">if</span> options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:deletetarget</span><span style="color: #006600; font-weight: bold;">]</span><br /> <br />   total_file_sizes = <span style="color: #006666;">0</span><br />   <span style="color: #cc00ff; font-weight: bold;">Dir</span>.<span style="color: #9900cc;">glob</span><span style="color: #006600; font-weight: bold;">(</span><span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">join</span><span style="color: #006600; font-weight: bold;">(</span>source, <span style="color: #996600;">'**/*'</span><span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">)</span>.<span style="color: #9900cc;">each</span> <span style="color: #9966cc; font-weight: bold;">do</span> <span style="color: #006600; font-weight: bold;">|</span> source_path <span style="color: #006600; font-weight: bold;">|</span><br /> <br />     target_path = source_path.<span style="color: #cc0066; font-weight: bold;">gsub</span> <span style="color: #cc00ff; font-weight: bold;">Regexp</span>.<span style="color: #9900cc;">new</span><span style="color: #006600; font-weight: bold;">(</span><span style="color: #996600;">"^"</span> <span style="color: #006600; font-weight: bold;">+</span> source<span style="color: #006600; font-weight: bold;">)</span>, target<br />     <span style="color: #9966cc; font-weight: bold;">if</span> <span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">file</span>? source_path<br /> <br />       <span style="color: #cc00ff; font-weight: bold;">FileUtils</span>.<span style="color: #9900cc;">mkdir_p</span> <span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">dirname</span><span style="color: #006600; font-weight: bold;">(</span>target_path<span style="color: #006600; font-weight: bold;">)</span><br />       <span style="color: #cc00ff; font-weight: bold;">FileUtils</span>.<span style="color: #9900cc;">ln</span> source_path, target_path<br />       total_file_sizes <span style="color: #006600; font-weight: bold;">+</span>= <span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">size</span><span style="color: #006600; font-weight: bold;">(</span>source_path<span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">if</span> options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:countsize</span><span style="color: #006600; font-weight: bold;">]</span><br />       <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"created hard link #{target_path}  (source: #{source_path}"</span> <span style="color: #9966cc; font-weight: bold;">if</span> verbose<br /> <br />     <span style="color: #9966cc; font-weight: bold;">else</span><br />       <span style="color: #cc00ff; font-weight: bold;">FileUtils</span>.<span style="color: #9900cc;">mkdir_p</span> target_path<br />       <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"created directory "</span> <span style="color: #006600; font-weight: bold;">+</span> target_path <span style="color: #9966cc; font-weight: bold;">if</span> verbose<br />     <span style="color: #9966cc; font-weight: bold;">end</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br />   <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"Done copying/linking."</span> <span style="color: #9966cc; font-weight: bold;">if</span> verbose<br /> <br />   <span style="color: #9966cc; font-weight: bold;">def</span> number_with_delimiter<span style="color: #006600; font-weight: bold;">(</span>number, delimiter=<span style="color: #996600;">","</span><span style="color: #006600; font-weight: bold;">)</span><br />     number.<span style="color: #9900cc;">to_s</span>.<span style="color: #cc0066; font-weight: bold;">gsub</span><span style="color: #006600; font-weight: bold;">(</span><span style="color: #006600; font-weight: bold;">/</span><span style="color: #006600; font-weight: bold;">(</span>\d<span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">(</span>?=<span style="color: #006600; font-weight: bold;">(</span>\d\d\d<span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">+</span><span style="color: #006600; font-weight: bold;">(</span>?!\d<span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">/</span>, <span style="color: #996600;">"<span style="color: #000099;">\\</span>1#{delimiter}"</span><span style="color: #006600; font-weight: bold;">)</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br />   <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"Bytes saved by linking: #{number_with_delimiter(total_file_sizes/1024000)} Mb"</span> <span style="color: #9966cc; font-weight: bold;">if</span> options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:countsize</span><span style="color: #006600; font-weight: bold;">]</span><br /> <br />   <span style="color: #9966cc; font-weight: bold;">if</span> options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:report</span><span style="color: #006600; font-weight: bold;">]</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"---- RESULT: SOURCE DIRECTORY"</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #cc00ff; font-weight: bold;">Dir</span>.<span style="color: #9900cc;">glob</span><span style="color: #006600; font-weight: bold;">(</span><span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">join</span><span style="color: #006600; font-weight: bold;">(</span>source, <span style="color: #996600;">'/**/*'</span><span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">)</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"---- TARGET DIRECTORY"</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #cc00ff; font-weight: bold;">Dir</span>.<span style="color: #9900cc;">glob</span><span style="color: #006600; font-weight: bold;">(</span><span style="color: #cc00ff; font-weight: bold;">File</span>.<span style="color: #9900cc;">join</span><span style="color: #006600; font-weight: bold;">(</span>target, <span style="color: #996600;">'/**/*'</span><span style="color: #006600; font-weight: bold;">)</span><span style="color: #006600; font-weight: bold;">)</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"---- RESULT END"</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br /> <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br /> <br /> <br /> <span style="color: #008000; font-style: italic;"># This hash will hold all of the options</span><br /> <span style="color: #008000; font-style: italic;"># parsed from the command-line by</span><br /> <span style="color: #008000; font-style: italic;"># OptionParser.</span><br /> options = <span style="color: #006600; font-weight: bold;">{</span><span style="color: #006600; font-weight: bold;">}</span><br /> <br /> optparse = OptionParser.<span style="color: #9900cc;">new</span> <span style="color: #9966cc; font-weight: bold;">do</span><span style="color: #006600; font-weight: bold;">|</span>opts<span style="color: #006600; font-weight: bold;">|</span><br />   <span style="color: #008000; font-style: italic;"># Set a banner, displayed at the top</span><br />   <span style="color: #008000; font-style: italic;"># of the help screen.</span><br />   opts.<span style="color: #9900cc;">banner</span> = <span style="color: #996600;">"Usage: ln_r.rb [options] source_dir target_dir"</span><br /> <br />   <span style="color: #008000; font-style: italic;"># Define the options, and what they do</span><br />   options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:verbose</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">false</span><br />   opts.<span style="color: #9900cc;">on</span><span style="color: #006600; font-weight: bold;">(</span> <span style="color: #996600;">'-v'</span>, <span style="color: #996600;">'--verbose'</span>, <span style="color: #996600;">'Output more information'</span> <span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">do</span><br />     options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:verbose</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">true</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br />   options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:test</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">false</span><br />   opts.<span style="color: #9900cc;">on</span><span style="color: #006600; font-weight: bold;">(</span> <span style="color: #996600;">'-t'</span>, <span style="color: #996600;">'--test'</span>, <span style="color: #996600;">'Run test copy on test data dirs - Andy only'</span> <span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">do</span><br />     options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:test</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">true</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br />   options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:report</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">false</span><br />   opts.<span style="color: #9900cc;">on</span><span style="color: #006600; font-weight: bold;">(</span> <span style="color: #996600;">'-r'</span>, <span style="color: #996600;">'--report'</span>, <span style="color: #996600;">'Display directory of source and target dirs after finish'</span> <span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">do</span><br />     options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:report</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">true</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br />   options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:countsize</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">false</span><br />   opts.<span style="color: #9900cc;">on</span><span style="color: #006600; font-weight: bold;">(</span> <span style="color: #996600;">'-c'</span>, <span style="color: #996600;">'--countsize'</span>, <span style="color: #996600;">'Display bytes saved by using hard linking'</span> <span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">do</span><br />     options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:countsize</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">true</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br />   options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:deletetarget</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">true</span><br />   opts.<span style="color: #9900cc;">on</span><span style="color: #006600; font-weight: bold;">(</span> <span style="color: #996600;">'-d'</span>, <span style="color: #996600;">'--dontdeletetarget'</span>, <span style="color: #996600;">'Dont rm -r * target directory first'</span> <span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">do</span><br />     options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:deletetarget</span><span style="color: #006600; font-weight: bold;">]</span> = <span style="color: #0000ff; font-weight: bold;">false</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br />   <span style="color: #008000; font-style: italic;">#options[:logfile] = nil</span><br />   <span style="color: #008000; font-style: italic;">#opts.on( '-l', '--logfile FILE', 'Write log to FILE' ) do|file|</span><br />   <span style="color: #008000; font-style: italic;">#  options[:logfile] = file</span><br />   <span style="color: #008000; font-style: italic;">#end</span><br /> <br />   <span style="color: #008000; font-style: italic;"># This displays the help screen, all programs are</span><br />   <span style="color: #008000; font-style: italic;"># assumed to have this option.</span><br />   opts.<span style="color: #9900cc;">on</span><span style="color: #006600; font-weight: bold;">(</span> <span style="color: #996600;">'-h'</span>, <span style="color: #996600;">'--help'</span>, <span style="color: #996600;">'Display this screen'</span> <span style="color: #006600; font-weight: bold;">)</span> <span style="color: #9966cc; font-weight: bold;">do</span><br />     <span style="color: #cc0066; font-weight: bold;">puts</span> opts<br />     <span style="color: #cc0066; font-weight: bold;">exit</span><br />   <span style="color: #9966cc; font-weight: bold;">end</span><br /> <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br /> <span style="color: #008000; font-style: italic;"># Parse the command-line. Remember there are two forms</span><br /> <span style="color: #008000; font-style: italic;"># of the parse method. The 'parse' method simply parses</span><br /> <span style="color: #008000; font-style: italic;"># ARGV, while the 'parse!' method parses ARGV and removes</span><br /> <span style="color: #008000; font-style: italic;"># any options found there, as well as any parameters for</span><br /> <span style="color: #008000; font-style: italic;"># the options. What's left is the list of files to resize.</span><br /> optparse.<span style="color: #9900cc;">parse</span>!<br /> <br /> <span style="color: #cc0066; font-weight: bold;">puts</span> <span style="color: #996600;">"Being verbose"</span> <span style="color: #9966cc; font-weight: bold;">if</span> options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:verbose</span><span style="color: #006600; font-weight: bold;">]</span><br /> <span style="color: #008000; font-style: italic;">#puts "Logging to file #{options[:logfile]}" if options[:logfile]</span><br /> <br /> <span style="color: #9966cc; font-weight: bold;">if</span> options<span style="color: #006600; font-weight: bold;">[</span><span style="color: #ff3333; font-weight: bold;">:test</span><span style="color: #006600; font-weight: bold;">]</span><br />   ln_r <span style="color: #996600;">"LinkTests1/dirA"</span>, <span style="color: #996600;">"LinkTests1/dirB"</span>, options<br />   ln_r <span style="color: #996600;">"LinkTests2/dirA"</span>, <span style="color: #996600;">"LinkTests2/dirB/MyCopy/Fred"</span>, options<br />   <span style="color: #cc0066; font-weight: bold;">exit</span><br /> <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br /> <span style="color: #9966cc; font-weight: bold;">if</span> ARGV.<span style="color: #9900cc;">length</span> <span style="color: #006600; font-weight: bold;">&lt;</span> <span style="color: #006666;">2</span><br />   <span style="color: #cc0066; font-weight: bold;">puts</span> optparse.<span style="color: #9900cc;">help</span><br />   <span style="color: #cc0066; font-weight: bold;">exit</span><br /> <span style="color: #9966cc; font-weight: bold;">end</span><br /> <br /> ln_r ARGV<span style="color: #006600; font-weight: bold;">[</span><span style="color: #006666;">0</span><span style="color: #006600; font-weight: bold;">]</span>, ARGV<span style="color: #006600; font-weight: bold;">[</span><span style="color: #006666;">1</span><span style="color: #006600; font-weight: bold;">]</span>, options</div>
<p>You can invoke it using:</p>
<p>ruby ln_r.rb [options] dir1 dir2 ...</p>
<p>-v, --verbose Output more information<br /> -t, --test Run test copy on test data dirs - Andy only<br /> -r, --report Display directory of source and target dirs after finish<br /> -c, --countsize Display bytes saved by using hard linking<br /> -d, --dontdeletetarget Dont rm -r * target directory first<br /> -h, --help Display this screen</p>
<p><a href="http://bit.ly/igXtBJ">Source code</a></p>
<h2>Update Feb 2013</h2>
<p>Its true that you can achieve the above in linux with</p>
<p><strong>cp -lr from to</strong> </p>
<p>where -r means recursive copy and -l mean use linking.  </p>
<p>Under windows, the COPY isn't so smart and so the above ruby script may be of help.  Alternatively you can use a port of the linux cp command under windows - and it seems to work OK.  See <a href="http://sourceforge.net/projects/unxutils/">Port of the most important GNU utilities to Windows</a>  </p>
<h1>Comments</h1>
<div class="guestBook-entry authorPost ">
<div class="contentByLine"><strong>Posted by <span class="userName">Reilly </span>on <span class="contentDate">Dec 20th, 2011</span></strong></div>
The unix/linux/posix command is:<br /><br />cp -al dir1 dir2<br /><br />"copy [cp] with archive [a] (recursive) and link [l]"</div>
<div class="guestBook-entry authorPost ">
<div class="guestBook-manage-links"> </div>
<div class="contentByLine"><strong>Posted by <span class="userName">admin </span>on <span class="contentDate">Dec 20th, 2011</span></strong></div>
</div>
<div class="guestBook-entry authorPost ">I wonder if Win 7 / NTFS has similar flags on the DOS copy command?</div>

</body>

</html>